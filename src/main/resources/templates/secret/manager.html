<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/layout}">

<head>
    <title>Account Manager</title>
</head>

<body>
<div layout:fragment="content" th:remove="tag">
    <div id="container">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <td scope="col">Username</td>
                    <td scope="col">Enabled</td>
                    <td scope="col">Groups</td>
                    <td scope="col">Tokens</td>
                    <td scope="col">Actions</td>
                </tr>
            </thead>
            <tbody>
            <th:block th:each="user : ${usersData}">
                <tr>
                    <td th:text="${user.username}"></td>
                    <td>
                        <div class="checkbox">
                            <label>
                            <input type="checkbox"
                                   th:checked="${user.enabled} ? 'checked'"
                                   th:data1="${user.username}"
                                   th:onclick="javascript:setUserEnabled(this, this.getAttribute('data1'));">
                            </label>
                        </div>
                    </td>
                    <td>
                        <table class="table table-condensed">
                            <thead>
                                <th:block th:each="group : ${user.groups}">
                                    <tr>
                                        <td th:text="${group.name()}"></td>
                                    </tr>
                                </th:block>
                            </thead>
                        </table>
                    </td>
                    <td>
                        <table class="table table-condensed">
                            <thead>
                            <th:block th:each="token : ${user.tokens}">
                                <tr>
                                    <td th:text="${token.token}"></td>
                                    <td th:text="${token.address.getHostAddress()}"></td>
                                    <td th:text="${#dates.format(token.expiresOn, 'dd-MM-yyyy HH:mm:ss')}"></td>
                                    <td>
                                        <button type="submit" class="btn btn-primary btn-group-sm"
                                                th:data1="${token.token}"
                                                th:onclick="javascript:expireToken(this.getAttribute('data1'))">Expire</button>
                                    </td>
                                </tr>
                            </th:block>
                            </thead>
                        </table>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-warning"
                                th:data1="${user.username}"
                                th:onclick="javascript:expireTokens(this.getAttribute('data1'))">Expire Tokens</button>
                        <button type="submit" class="btn btn-danger"
                                th:data1="${user.username}"
                                th:onclick="javascript:unregister(this.getAttribute('data1'))">Unregister</button>
                    </td>
                </tr>
            </th:block>
            </tbody>
        </table>
        <form>
            <div class="row">
                <div class="col-md-6 col-md-offset-3">
                    <div id="registerStatus"></div>
                    <div class="form-group">
                        <label for="usernameInput" class="control-label">Username</label>
                        <input type="text" class="form-control" id="usernameInput">
                    </div>
                    <div class="form-group">
                        <label for="passwordInput" class="control-label">Password</label>
                        <input type="password" class="form-control" id="passwordInput">
                    </div>
                    <div class="form-group">
                        <label for="groupsInput" class="control-label">Groups</label>
                        <select multiple class="form-control" id="groupsInput">
                            <option th:block th:each="group : ${authGroups}" th:value="${group.name()}" th:text="${group.name()}" th:selected="${group.name()} == 'DEV'"></option>
                        </select>
                    </div>
                    <div class="form-group checkbox">
                        <label class="control-label">
                            <input type="checkbox" checked="checked" id="enabledInput">Enable
                        </label>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="register()">Register User</button>
                </div>
            </div>
        </form>
    </div>
    <script src="/js/jquery-min-3.3.1.js"></script>
    <script>
        function setUserEnabled(checkbox, username) {
            (async (en, un) => {
                try {
                    return await $.ajax({
                        type: 'GET',
                        url: `user/set/enabled/${un}`,
                        data: {
                            enabled: en,
                        }
                    });
                } catch (e) {
                    console.log(e);
                }
            })(checkbox.checked, username).then(result => {
                location.reload(false);
            });
        }

        function expireToken(token) {
            (async (tk) => {
                try {
                    return await $.ajax({
                        type: 'GET',
                        url: `user/tokens/expire/${tk}`
                    });
                } catch (e) {
                    console.log(e);
                }
            })(token).then(result => {
                location.reload(false);
            });
        }

        function expireTokens(username) {
            (async (un) => {
                try {
                    return await $.ajax({
                        type: 'GET',
                        url: `user/tokens/user/${un}/expire`
                    });
                } catch (e) {
                    console.log(e);
                }
            })(username).then(result => {
                location.reload(false);
            });
        }

        function unregister(username) {
            (async (un) => {
                try {
                    return await $.ajax({
                        type: 'GET',
                        url: `user/unregister/${un}`
                    });
                } catch (e) {
                    console.log(e);
                }
            })(username).then(result => {
                location.reload(false);
            });
        }

        function register() {
            $('#registerStatus').empty();
            (async (d) => {
                    return await $.ajax({
                        type: 'POST',
                        url: 'user/register',
                        data: JSON.stringify(d),
                        contentType: 'application/json',
                        dataType: 'json',
                    })
            })({
                username: $('#usernameInput').val(),
                password: $('#passwordInput').val(),
                groups: $('#groupsInput').val(),
                enabled: $('#enabledInput').prop('checked'),
            }).then(result => {
                if(result !== undefined) location.reload(false);
            }).catch(err => {
                let msg = 'Failed to register user';
                if(err.responseJSON !== undefined) msg = err.responseJSON.message;
                $('#registerStatus').append(
                    $('<div/>')
                    .addClass('alert alert-danger')
                    .text(msg)
                );
                console.error(err);
            })
        }
    </script>
</div>
</body>

</html>
