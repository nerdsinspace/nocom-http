<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/layout}">

<head>
    <title>Account Manager</title>
</head>

<body>
<div layout:fragment="content" th:remove="tag">
    <div id="container">
        <div>
            <h2 class="text-center">Accounts</h2>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <td scope="col">Username</td>
                        <td scope="col">Enabled</td>
                        <td scope="col">Groups</td>
                        <td scope="col">Tokens</td>
                        <td scope="col">Actions</td>
                    </tr>
                </thead>
                <tbody>
                <th:block th:each="user : ${usersData}">
                    <tr>
                        <td th:text="${user.username}"></td>
                        <td>
                            <div class="checkbox">
                                <label>
                                <input type="checkbox"
                                       th:checked="${user.enabled} ? 'checked'"
                                       th:data1="${user.username}"
                                       th:onclick="javascript:setUserEnabled(this, this.getAttribute('data1'));">
                                </label>
                            </div>
                        </td>
                        <td>
                            <table class="table table-condensed">
                                <thead>
                                    <th:block th:each="group : ${user.groups}">
                                        <tr>
                                            <td th:text="${group.name()}"></td>
                                        </tr>
                                    </th:block>
                                </thead>
                            </table>
                        </td>
                        <td>
                            <table class="table table-condensed">
                                <thead>
                                <th:block th:each="token : ${user.tokens}">
                                    <tr>
                                        <td th:text="${token.token}"></td>
                                        <td th:text="${token.address.getHostAddress()}"></td>
                                        <td th:text="${#dates.format(token.expiresOn, 'dd-MM-yyyy HH:mm:ss')}"></td>
                                        <td>
                                            <button type="submit" class="btn btn-primary btn-sm"
                                                    th:data1="${token.token}"
                                                    th:onclick="javascript:expireSingleToken(this.getAttribute('data1'))">Expire</button>
                                        </td>
                                    </tr>
                                </th:block>
                                </thead>
                            </table>
                        </td>
                        <td>
                            <button type="submit" class="btn btn-warning"
                                    th:data1="${user.username}"
                                    th:onclick="javascript:expireTokens(this.getAttribute('data1'))">Expire Tokens</button>
                            <button type="submit" class="btn btn-danger"
                                    th:data1="${user.username}"
                                    th:onclick="javascript:unregister(this.getAttribute('data1'))">Unregister</button>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>
        <div>
            <h2 class="text-center">Add Account</h2>
            <form>
                <div class="row">
                    <div class="col-md-6 col-md-offset-3">
                        <div id="registerStatus"></div>
                        <div class="form-group">
                            <label for="usernameInput" class="control-label">Username</label>
                            <input type="text" class="form-control" id="usernameInput">
                        </div>
                        <div class="form-group">
                            <label for="passwordInput" class="control-label">Password</label>
                            <input type="password" class="form-control" id="passwordInput">
                        </div>
                        <div class="form-group">
                            <label for="groupsInput" class="control-label">Groups</label>
                            <select multiple class="form-control" id="groupsInput">
                                <option th:block th:each="group : ${authGroups}" th:value="${group.name()}" th:text="${group.name()}" th:selected="${group.name()} == 'DEV'"></option>
                            </select>
                        </div>
                        <div class="form-group checkbox">
                            <label class="control-label">
                                <input type="checkbox" checked="checked" id="enabledInput">Enable
                            </label>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="register()">Register User</button>
                    </div>
                </div>
            </form>
        </div>
        <div>
            <h2 class="text-center">Tools</h2>
            </br>
            <div class="row">
                <div class="text-center">
                    <a href="/api/database/download">
                        <button class="btn"><i class="fa fa-download"></i>Download Database</button>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <script src="/js/jquery-min-3.3.1.js"></script>
    <script>
        function _reloadPage(result) {
            location.reload(false);
        }

        async function _setUserEnabled(checked, username) {
            try {
                return await $.ajax({
                    type: 'GET',
                    url: `user/set/enabled/${username}`,
                    data: {
                        enabled: checked,
                    }
                });
            } catch (e) {
                console.error(e);
            }
        }
        function setUserEnabled(checkbox, username) {
            _setUserEnabled(checkbox.checked, username).then(_reloadPage);
        }

        async function _expireSingleToken(token) {
            try {
                return await $.ajax({
                    type: 'GET',
                    url: `user/tokens/expire/${token}`
                });
            } catch (e) {
                console.error(e);
            }
        }
        function expireSingleToken(token) {
            _expireSingleToken(token).then(_reloadPage);
        }

        async function _expireTokens(username) {
            try {
                return await $.ajax({
                    type: 'GET',
                    url: `user/tokens/user/${username}/expire`
                });
            } catch (e) {
                console.error(e);
            }
        }
        function expireTokens(username) {
            _expireTokens(username).then(_reloadPage);
        }

        async function _unregister(username) {
            try {
                return await $.ajax({
                    type: 'GET',
                    url: `user/unregister/${username}`
                });
            } catch (e) {
                console.error(e);
            }
        }
        function unregister(username) {
            _unregister(username).then(_reloadPage);
        }

        async function _register(data) {
            return await $.ajax({
                type: 'POST',
                url: 'user/register',
                data: JSON.stringify(data),
                contentType: 'application/json',
            });
        }
        function register() {
            $('#registerStatus').empty();
            _register({
                username: $('#usernameInput').val(),
                password: $('#passwordInput').val(),
                groups: $('#groupsInput').val(),
                enabled: $('#enabledInput').prop('checked'),
            }).then(result => {
                if(result !== undefined) location.reload(false);
            }).catch(err => {
                let msg = 'Failed to register user';
                if(err.responseJSON !== undefined) msg = err.responseJSON.message;
                $('#registerStatus').append(
                    $('<div/>')
                    .addClass('alert alert-danger')
                    .text(msg)
                );
                console.error(err);
            })
        }
    </script>
</div>
</body>

</html>
